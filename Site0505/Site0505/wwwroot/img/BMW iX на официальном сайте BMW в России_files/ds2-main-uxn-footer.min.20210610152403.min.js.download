/**
 * partial: navigation-footer
 * author: ronny
 *
 */
define('ds2-main-uxn-footer', [
        'jquery',
        'ds2-main',
        'ds2-tracking', 'ds2-page-context', 'postal', 'focus-visible'],
    function ($, Main, tracking, context, postal) {

        const URL_PLACEHOLDER = "URL_PLACEHOLDER";

        function MainUXNFooter(component) {
            this.$component = $(component);
            this.$component.ds2TrackingBase(tracking.getOptions('ds2-main-uxn-footer'));
            this.alternateLinks = null;
            this.init();
            this.composeShareUrlsBasedOnCurrentPage();
        }

        var proto = MainUXNFooter.prototype;

        proto.markActiveLanguage = function (el) {
            var parent = $(el.closest('li'));
            var lang = parent.data('langCode');
            var lang_consentCookie = window.consentcontroller ? window.consentcontroller.api.getCookie('lang_consentCookie') : null;
            el.addClass('ds2-language-link-active');
            if (lang != lang_consentCookie && window.consentcontroller) {
                window.consentcontroller.api.setPersistence('lang_consentCookie', '/' + lang);
            }
            return lang;
        };

        proto.isEmpty = function (value) {
            if (value == null || value == undefined || $.trim(value).length == 0) {
                return true;
            }
            return false;
        };

        proto.findAlternateLink = function (lang) {
            var alternateLinks = $('html').find('head').find('link[rel="alternate"]');
            var alternateLink = null;
            $.each(alternateLinks, function (index, el) {
                var l = $(el).attr('hreflang');
                if (l == lang) {
                    if (window.location.hash) {
                        alternateLink = $(el).attr("href") + window.location.hash;
                    } else if (window.location.search) {
                        alternateLink = $(el).attr("href") + window.location.search;
                    } else {
                        alternateLink = $(el).attr("href");
                    }
                }
            });

            if (this.isEmpty(alternateLink)) {
                alternateLink = this.defaultLink(lang);
            }
            return alternateLink;
        };

        proto.defaultLink = function (lang) {
            var redirectTo = window.location.origin;
            var link = "";
            $.each(this.alternateLinks, function(index,el){

                if(el.language == lang){
                    link = el.path;
                }
            });

            if (!(link.startsWith("http://") || link.startsWith("https://"))) {
                link = redirectTo + link;
            }
            return link;
        };

        proto.clickLanguage = function (event) {
            var currentTarget = $(event.currentTarget);
            var lang = this.markActiveLanguage(currentTarget);
            var alternateLink = this.findAlternateLink(lang, currentTarget);
            this.trackLanguageLinkClick(alternateLink, currentTarget.attr('title'));

            window.location.replace(alternateLink);
        };

        proto.trackLanguageLinkClick = function(alternateLink, title) {
            var trackingOptions =  {
                name: 'selection',
                timing: true,
                useTimer: false,
                active: true
            };
            var event = {
                relatedComponent: this.$component.data('tracking-component'),
                eventInfo: {
                    eventName: title,
                    eventAction: 'Selection',
                    eventPoints: '',
                    timestamp: new Date().getTime(),
                    cause: 'footer',
                    effect: 'click',
                    element: 'Text link',
                    target: alternateLink,
                },
                    category: {
                        mmdr: '',
                        eventType: 'triggered',
                        primaryCategory: '',
                        subCategory01: ''
                    },
                };

            window.digitals2.tracking.dispatcher.trackEvent(event, trackingOptions);
        };

        proto.getLanguageFromPath = function () {

            var pathname = window.location.pathname;
            var lang = null;
            var s = pathname.split('/');
            if (pathname.startsWith('/content')) {
                lang = s[5];
                if (lang.indexOf('_') > 0) {
                    lang = lang.slice(0, lang.indexOf('_'));
                }
            } else {
                lang = s[1];
            }
            return lang;
        };

        proto.moveFooterDisclaimer = function() {
            var footnoteDisclaimer = $(document).find('div.ds2-disclaimer.ds2-disclaimer-footnote');
            if (footnoteDisclaimer.length > 0) {
                var footnoteParent = footnoteDisclaimer.parent();
                var placeholder = this.$component.find('.ds2-disclaimer-footnote-placeholder');
                placeholder.html(footnoteParent[0].outerHTML);
                footnoteParent.remove();
            }
        };

        proto.hasPageContext = function () {
            return $('html').find('head').find('ds2-page-context').length > 0;
        };

        proto.composeShareUrlsBasedOnCurrentPage = function () {
            $(".ds2-share-link-universal").each(function() {
                var href = $(this).attr('href');
                if (href && href.indexOf(URL_PLACEHOLDER) >= 0) {
                    var composedUrl = href.replace(URL_PLACEHOLDER, window.location);
                    $(this).attr('href', composedUrl);
                }
            });
        };

        proto.init = function () {
            var parentSelf = this;

            this.moveFooterDisclaimer();

            $('.ds2-language-link', this.$component).each(function () {
                $(this).on('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (parentSelf.alternateLinks == null || parentSelf.alternateLinks == undefined) {
                        if (!parentSelf.hasPageContext()) {
                            var alternateLinks = $('html').find('head').find('link[rel="alternate"]');
                            if (alternateLinks) {
                                parentSelf.alternateLinks = alternateLinks;
                                parentSelf.clickLanguage(e);
                            }
                        }
                        postal.publish({
                            channel: context.CHANNEL,
                            topic: 'get',
                            data: function (data) {
                                parentSelf.alternateLinks = data[context.ALTERNATIVE_LANG_PAGES];
                                parentSelf.clickLanguage(e);
                            }
                        });
                    } else {
                        parentSelf.clickLanguage(e);
                    }
                })
            });
            var lang_consentCookie = this.getLanguageFromCookie();

            if (this.isEmpty(lang_consentCookie)) {
                lang_consentCookie = document.documentElement.lang && document.documentElement.lang.slice(0,2) || this.getLanguageFromPath();
            }
            // in case the init event is already fired, the configurator url will be received via callback.

            var links = $(this.$component).find('.ds2-language-list').find('li');
            var link = null;
            $(links).each(function (index, el) {
                if ($(el).data('langCode') == lang_consentCookie) {
                    link = $(el).find('a');
                }
            });

            postal.publish({
                channel: context.CHANNEL,
                topic: 'get',
                data: function (data) {
                    parentSelf.alternateLinks = data[context.ALTERNATIVE_LANG_PAGES];
                    $(links).each(function(index, el){
                       var lang_code = $(el).data('langCode');
                        var  l = $(el).find('a');
                        var alternateLink = parentSelf.findAlternateLink(lang_code);
                        $(l).attr("href", alternateLink);
                    });
                }
            });



            this.markActiveLanguage($(link));
        };

        proto.getLanguageFromCookie = function(){
            var lang_consentCookie = null;
            if(window.consentcontroller && window.consentcontroller.api){
                lang_consentCookie = window.consentcontroller.api.getCookie('lang_consentCookie');
            }
            if (!this.isEmpty(lang_consentCookie)) {
                lang_consentCookie = lang_consentCookie.replace('/', '');
            }
            return lang_consentCookie;
        };

        return MainUXNFooter;
    });
